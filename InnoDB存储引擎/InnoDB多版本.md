# 14.3 InnoDB 多版本
InnoDB 是一个多版本的存储引擎：它保留有关已更改行的旧版本的信息，以支持并发和回滚等事务功能。此信息以`rollback segment`这样一个数据结构(在Oracle中的类似数据结构之后)的形式存储在表空间。InnoDB使用回滚段中的这份信息来执行事务回滚中所需的撤消操作。它还使用该信息构建行的早期版本以进行一致性读取。

在内部，InnoDB为存储在数据库中的每一行添加三个字段。 6字节的DB_TRX_ID字段指示插入或更新该行的最后一个事务的事务标识符。此外，删除在内部被视为更新，其中行中的特殊位被设置为将其标记为已删除。每行还包含一个7字节的DB_ROLL_PTR字段，称为滚动指针。滚动指针指向写入回滚段的撤消日志记录。如果更新了行，则撤消日志记录包含在更新行之前重建行内容所需的信息。 6字节的DB_ROW_ID字段包含在插入新行时单调增加的行ID。如果InnoDB自动生成聚簇索引，则索引包含行ID值。否则，DB_ROW_ID列不会出现在任何索引中。

回滚段中的撤消日志分为插入和更新撤消日志。只在事务回滚中需要插入撤消日志，并且可以在事务提交后立即丢弃。更新撤消日志也用于一致性读取，但只有在InnoDB没有分配快照的事务之后才能丢弃它们，在一致读取中可能需要更新撤消日志中的信息来构建早期版本的数据库行。

定期提交你的事务，包含那些只有一致性读的事务。否则，InnoDB无法通过更新的撤销日志丢弃数据，而且rollback segment 会变的太大，从而填满表空间。

回滚段中的撤消日志记录的物理大小通常小于相应的插入或更新的行。您可以使用此信息计算回滚段所需的空间。

在InnoDB多版本控制方案中，当您使用SQL语句删除行时，不会立即从数据库中物理删除该行。 InnoDB在丢弃为删除写入的更新撤消日志记录时，仅物理删除相应的行及其索引记录。此删除操作称为清除，并且速度非常快，通常与执行删除的SQL语句的时间顺序相同。

如果你在表中以大约相同的速率插入和删除小规模批次的行，则清除线程可能开始落后，并且由于所有“死”行，表可以变得越来越大，使得所有操作都受到磁盘限制并且会变慢。在这种情况下，通过调整innodb_max_purge_lag系统变量来限制新行操作，并为清除线程分配更多资源。更多信息，请参见第14.14节“InnoDB启动选项和系统变量”。

## 多版本和二级索引

InnoDB多版本并发控制（MVCC）以不同于聚簇索引的方式处理二级索引。聚簇索引中的记录就地更新，其隐藏的系统列指向可以重建早期版本记录的撤消日志条目。与聚簇索引记录不同，二级索引记录不包含隐藏的系统列，也不会就地更新。

当更新一个二级索引列时，旧的二级索引记录被打上删除标记，新的记录被插入进来，然后永久删除被打上删除标记的记录。当二级索引记录被打上删除标记或者二级索引页由于较新的事务更新时，InnoDB会在聚簇索引中查找数据库记录。在聚簇索引中，将检查记录的DB_TRX_ID，如果在启动读取事务后修改了记录，则会从撤消日志中检索正确的记录版本。

如果一个二级索引记录被标记删除，或二级索引页由于新事务更新时，无法使用`覆盖索引`技术。 InnoDB不是从索引结构返回值，而是在聚簇索引中查找记录。

但是，如果启用了`索引条件下沉（index condition pushdown，ICP）`优化，并且只能使用索引中的字段来评估WHERE条件的某些部分，则MySQL服务器仍会将WHERE条件的这一部分向下推送到存储引擎，在那里评估它使用索引。如果未找到匹配的记录，则避免聚簇索引查找。如果找到匹配的记录，即使在删除标记的记录中，InnoDB也会在聚集索引中查找记录。

